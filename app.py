import streamlit as st
import os
import zipfile
import streamlit.components.v1 as components

# -----------------------------------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì • (ê¸°ì¡´ ìœ ì§€)
# -----------------------------------------------------------------------------
st.set_page_config(layout="wide", page_title="ì—´ëŒ€ê³¼ì¼ ì ì •ì¬ë°°ì§€ ì§€ë„")

# CSS ì£¼ì… (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€)
st.markdown("""
    <style>
    [data-testid="stSidebar"] h1 { font-size: 28px !important; }
    .stRadio p { font-size: 18px !important; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

# -----------------------------------------------------------------------------
# [ì¶”ê°€ë¨] ì••ì¶• í•´ì œ í•¨ìˆ˜ (ì§€ë„ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ í•„ìˆ˜)
# -----------------------------------------------------------------------------
def unzip_maps():
    # html íŒŒì¼ì´ ë‘˜ ë‹¤ ìˆìœ¼ë©´ í•´ì œí•˜ì§€ ì•ŠìŒ
    if os.path.exists("mango_map.html") and os.path.exists("papaya_map.html"):
        return
    # zip íŒŒì¼ì´ ìˆìœ¼ë©´ í•´ì œ
    if os.path.exists("maps.zip"):
        with zipfile.ZipFile("maps.zip", 'r') as zip_ref:
            zip_ref.extractall(".")

unzip_maps()

# -----------------------------------------------------------------------------
# 2. ì‚¬ì´ë“œë°” UI (ê¸°ì¡´ ê¸°ëŠ¥ ëª¨ë‘ ìœ ì§€)
# -----------------------------------------------------------------------------
st.sidebar.header("ì˜µì…˜ ì„ íƒ")

# (1) ì‘ë¬¼ ì„ íƒ
selected_fruit = st.sidebar.radio("ì‘ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”:", ["ë§ê³ ", "íŒŒíŒŒì•¼"])

st.sidebar.markdown("---")

# (2) ì—°ë„ ë° ì‹œë‚˜ë¦¬ì˜¤ (ê¸°ì¡´ UI ìœ ì§€)
# ì£¼ì˜: ì§€ë„ëŠ” ì´ë¯¸ ì™„ì„±ëœ HTMLì„ ë³´ì—¬ì£¼ë¯€ë¡œ, ì´ ìŠ¬ë¼ì´ë”ë“¤ì´ ì§€ë„ ëª¨ì–‘ì„ ì¦‰ì‹œ ë°”ê¾¸ì§„ ì•Šì§€ë§Œ
# UI êµ¬ì„±ìš”ì†Œë¡œ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤.
selected_year = st.sidebar.selectbox("ì˜ˆì¸¡ ì—°ë„ ì„ íƒ", [2025, 2030, 2040, 2050])

st.sidebar.markdown("### ğŸŒ¡ï¸ ê¸°í›„ ë³€í™” ì‹œë‚˜ë¦¬ì˜¤ ì„¤ì •")
temp_change = st.sidebar.slider("í‰ê·  ê¸°ì˜¨ ìƒìŠ¹í­ (â„ƒ)", 0.0, 5.0, 1.5, 0.1)
rain_change = st.sidebar.slider("ê°•ìˆ˜ëŸ‰ ë³€í™”ìœ¨ (%)", -20, 20, 0, 5)

st.sidebar.info(f"""
**ì„¤ì •ëœ ì‹œë‚˜ë¦¬ì˜¤:**
- ëª©í‘œ ì—°ë„: {selected_year}ë…„
- ê¸°ì˜¨: +{temp_change}â„ƒ
- ê°•ìˆ˜ëŸ‰: {rain_change}%
""")

# -----------------------------------------------------------------------------
# 3. ë©”ì¸ í™”ë©´ êµ¬ì„±
# -----------------------------------------------------------------------------
st.title("ğŸ ì—´ëŒ€ê³¼ì¼ ì ì • ì¬ë°°ì§€ ë¶„ì„ ê²°ê³¼")
st.write(f"ê¸°í›„ ë°ì´í„° ë¶„ì„ì„ í†µí•´ ë„ì¶œëœ **{selected_year}ë…„ {selected_fruit}** ì ì • ì¬ë°°ì§€ ì§€ë„ì…ë‹ˆë‹¤.")

# [ì¤‘ìš”] ì„ì˜ ë°ì´í„°(REGION_DATA)ì™€ Folium ì½”ë“œ ë¶€ë¶„ì„ ì‚­ì œí•˜ê³ 
# ì•„ë˜ì˜ HTML íŒŒì¼ ë¡œë“œ ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´í–ˆìŠµë‹ˆë‹¤.

def show_html_map(file_name):
    # íŒŒì¼ í™•ì¸
    if not os.path.exists(file_name):
        st.error(f"âš ï¸ ì§€ë„ íŒŒì¼({file_name})ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. maps.zipì„ ì—…ë¡œë“œí–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
        return

    # HTML íŒŒì¼ ì½ê¸°
    with open(file_name, 'r', encoding='utf-8') as f:
        map_html = f.read()
    
    # ì§€ë„ ì¶œë ¥ (ë†’ì´ ì¡°ì ˆ ê°€ëŠ¥)
    components.html(map_html, height=700, scrolling=True)

# ì„ íƒëœ ì‘ë¬¼ì— ë”°ë¼ ì§€ë„ íŒŒì¼ ë³´ì—¬ì£¼ê¸°
if selected_fruit == "ë§ê³ ":
    st.subheader(f"ğŸ¥­ ë§ê³  ì¬ë°°ì§€ ë¶„ì„ ì§€ë„")
    show_html_map("mango_map.html")

elif selected_fruit == "íŒŒíŒŒì•¼":
    st.subheader(f"ğŸˆ íŒŒíŒŒì•¼ ì¬ë°°ì§€ ë¶„ì„ ì§€ë„")
    show_html_map("papaya_map.html")

# -----------------------------------------------------------------------------
# ì°¸ê³ : í•˜ë‹¨ì˜ í‘œ(DataFrame)ë‚˜ ì°¨íŠ¸ëŠ” ê¸°ì¡´ ì„ì˜ ë°ì´í„°ë¥¼ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì—
# ì‹¤ì œ ë¶„ì„ ë°ì´í„°ì™€ ë§ì§€ ì•Šì•„ ì œê±°í–ˆìŠµë‹ˆë‹¤. 
# ë§Œì•½ ì‹¤ì œ ë¶„ì„ ë°ì´í„°(CSV ë“±)ê°€ ìˆë‹¤ë©´ ì¶”ê°€ë¡œ ë„ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
# -----------------------------------------------------------------------------
